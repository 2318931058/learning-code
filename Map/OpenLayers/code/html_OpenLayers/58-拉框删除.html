<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script src="./OL_SDK/include-openlayers-local.js"></script>
    <script src="./libs/gaode.js"></script>
    <script src="./utils/queryByGeom.js"></script>
    <script src="./utils/createDraw.js"></script>
    <script src="./utils/getFeatureGeom.js"></script>
    <script src="./utils/delFeature.js"></script>
  </head>
  <body>
    <button onclick="activeDraw()">激活画笔</button>
    <div id="map"></div>
    <script>
      var docLayer = new Zondy.Map.Doc("", "doc01", {});
      var map = new ol.Map({
        target: "map",
        layers: [gaode_vector, docLayer],
        view: new ol.View({
          projection: "EPSG:4326",
          center: [114.3, 30.5],
          zoom: 4,
        }),
      });

      let service = {
        name: "doc01",
        layerId: 2,
      };

      // 设置图片标注样式
      const style = new ol.style.Style({
        image: new ol.style.Icon({
          anchor: [0.5, 60],
          anchorOrigin: "top-right",
          anchorXUnits: "fraction",
          anchorYUnits: "pixels",
          offsetOrigin: "top-right",
          // offset:[0,10],
          //图标缩放比例
          scale: 0.2,
          //透明度
          opacity: 0.75,
          //图标的url
          src: "./images/location.png",
        }),
      });
      //   创建标注数据源、图层
      let markerSource = new ol.source.Vector({});
      let markerLayer = new ol.layer.Vector({
        source: markerSource,
      });
      map.addLayer(markerLayer);

      //   创建画布
      let draw;
      let source = new ol.source.Vector({});
      let layer = new ol.layer.Vector({
        source,
      });
      map.addLayer(layer);

      function activeDraw() {
        // 激活画笔
        draw = createDraw({
          type: "Box",
          source,
        });
        map.addInteraction(draw);

        draw.on("drawend", (evt) => {
          let geometry = evt.feature.getGeometry();
          service;
          Query.queryByGeom({
            geometry,
            service,
            success,
          });
        });
      }

      function success(data) {
        var features = new Zondy.Format.PolygonJSON().read(data);
        features.forEach((item) => {
          let position = getFeatureGeom(item);
          let markerFeature = new ol.Feature({
            geometry: new ol.geom.Point(position[0]),
          });
          markerFeature.setStyle(style);
          markerSource.addFeature(markerFeature);
        });
        // console.log(features);
        // 拉框删除
        let fids = [];
        features.forEach((item) => {
          // 获取框选要素的fid值
          fids.push(+item.id_);
        });
        // 调用封装的方法删除要素
        delFeature({
          fids,
          service,
          docLayer,
        });

        // 移除画笔
        map.removeInteraction(draw);
        //   清除标注
        markerSource.clear();
        //   清除画布
        source.clear();
      }
    </script>
  </body>
</html>
